don_phyto=merge(don_leaf,don_inflo,all.x=T,all.y=F)
summary(don_phyto)
# table state inflo -------------------------------------------------------
INFLO_STATUS=c(1,9,10,12,17,18,20,42,50,82,146,266)
sex=c('undeterminated','male','male','male','female','female','female','male','female','female','female','male')
state=c('initiated','initiated','non aborted','aborted','initiated','non aborted','aborted','spathe','spathe','oleosynthesis','harvested','senescent')
table_state=data.frame(INFLO_STATUS,sex,state)
levels(table_state$state)=list("initiated"="initiated","aborted"='aborted','non aborted'='non aborted','spathe'='spathe','oleosynthesis'='oleosynthesis','harvested'='harvested','senescent'='senescent')
table_state=table_state%>%
mutate(state=as.character(state),
INFLO_STATUS=as.numeric(INFLO_STATUS))
don_phyto=don_phyto%>%
mutate(INFLO_STATUS=as.numeric(INFLO_STATUS))%>%
as.data.frame()
don_phyto=merge(don_phyto,table_state,all.x=T)
don_phyto%>%
group_by(date)%>%
summarise(totalLeafArea=sum(LEAFAREA,na.rm=T))%>%
ggplot(aes(x=date,y=totalLeafArea))+
geom_line()
don_phyto%>%
# filter(NUMBER %in% c(-76,-50,-11,5,10,15,24))%>%
filter(NUMBER %in% seq(-110,40,5))%>%
mutate(num=paste('phyto #',sprintf( '%03d',NUMBER)))%>%
arrange(date,NUMBER)%>%
group_by(NUMBER)%>%
# filter(RANK>-15 & RANK<65)%>%
ggplot(aes(x=RANK,y=NUMBER,col=state,shape=sex))+
# geom_hline(aes(yintercept =SF_FIN),col=2)+
geom_vline(aes(xintercept =0),lty=2)+
geom_vline(aes(xintercept =50),lty=2)+
# geom_vline(aes(xintercept =TT_INI_FLOWERING,lty='flow'))+
# facet_wrap(~NUMBER)+
geom_point(size=4)+
geom_line(aes(group=num))+
scale_color_viridis_d()+
ylab('# phytomer')+
xlab('Leaf rank')+
myTheme+
theme(legend.position='right')
View(don_phyto)
don_phyto%>%
group_by(date)%>%
summarise(totalLeafArea=sum(LEAFAREA,na.rm=T))%>%
ggplot(aes(x=date,y=totalLeafArea))+
geom_line()
don_phyto%>%
group_by(date)%>%
filter(LEAFAREA>0)%>%
summarise(NumberofLeaves=n())%>%
ggplot(aes(x=date,y=NumberofLeaves))+
geom_line()
View(don_phyto)
don_phyto%>%
group_by(date,sex)%>%
filter(LEAFAREA>0)%>%
summarise(NumberofLeaves=n())
don_phyto%>%
group_by(date,sex)%>%
filter(LEAFAREA>0)%>%
summarise(NumberofLeaves=n())%>%
ungroup()%>%
tidyr::spread(sex)
don_phyto%>%
group_by(date,sex)%>%
filter(LEAFAREA>0)%>%
summarise(NumberofLeaves=n())%>%
ungroup()%>%
tidyr::spread(sex)
df <- data.frame(row = rep(c(1, 51), each = 3),
var = c("Sepal.Length", "Species", "Species_num"),
value = c(5.1, "setosa", 1, 7.0, "versicolor", 2))
df %>% spread(var, value) %>% str
df <- data.frame(row = rep(c(1, 51), each = 3),
var = c("Sepal.Length", "Species", "Species_num"),
value = c(5.1, "setosa", 1, 7.0, "versicolor", 2))
df %>% spread(var, value)
df
don_phyto%>%
group_by(date,sex)%>%
filter(LEAFAREA>0)%>%
summarise(NumberofLeaves=n())%>%
ungroup()%>%
tidyr::spread(sex,NumberofLeaves)
don_phyto%>%
group_by(date,sex)%>%
filter(LEAFAREA>0)%>%
summarise(NumberofLeaves=n())%>%
ungroup()%>%
tidyr::spread(sex,NumberofLeaves)%>%
mutate(NumberofLeaves=female+male)
don_phyto%>%
group_by(date,sex)%>%
filter(LEAFAREA>0)%>%
summarise(NumberofLeaves=n())%>%
ungroup()%>%
tidyr::spread(sex,NumberofLeaves)%>%
mutate(NumberofLeaves=female+male)%>%
ggplot()+
geom_line(aes(x=date,y=male,col='male'))+
geom_line(aes(x=date,y=female,col='female'))+
geom_line(aes(x=date,y=NumberofLeaves))
write.table(x = meteofile,file = '../parameters/meteo.txt',row.names = F,quote=F,col.names = F,sep='\t')
dir_raw = '../parameters/'
#' @param dir_raw directory of the raw meteo file
#' @param date_ini starting date (dd-mm-yyyy) if NULL takes the first date in the raw file)
#' @param date_end ending date (dd-mm-yyyy)if NULL takes the last date in the raw file
#'
#' @return meteofile
#' @export meteofile
#'
#' @examples
#' filename='meteo_SMSE'
#' dir_raw = '../parameters/'
generate_meteo=function(dir_raw,filename,date_ini=NULL,date_end=NULL){
meteofile= read.table(file = paste0(dir_raw,filename,'.txt'),header = F)
colnames(meteofile)=c('day','month','year','TMax','TMin','HRMax','HRMin','WindSpeed','Rg','Rainfall')
meteofile=meteofile%>%
mutate(date=dmy(paste(day,month,year)))
min=min(meteofile$date)
max=max(meteofile$date)
if (!is.null(date_ini)){
date_ini=dmy(date_ini)
if(date_ini<min){
print(paste('error: select date_ini after',min))
return(NULL)
}
}else{date_ini=min}
if (!is.null(date_end)){
date_end=dmy(date_end)
if(date_end>max){
print(paste('error: select date_end before',max))
return(NULL)
}
}else{date_end=max}
meteofile=meteofile%>%
filter(date>=date_ini & date<=date_end)%>%
select(-date)
write.table(x = meteofile,file = '../parameters/meteo.txt',row.names = F,quote=F,col.names = F,sep='\t')
print(paste('meteo file generated from',date_ini,'to',date_end))
}
met_SMSE=data.table::fread(input = '../R/Data/Meteo_extract_BDD_SMSE.txt')%>%
mutate(date=ymd(ObservationDate))
range(met_SMSE$date)
met_SMSE=met_SMSE%>%
mutate(day=as.numeric(str_sub(string = ObservationDate,start = 9,end = 10)),
month=as.numeric(str_sub(string = ObservationDate,start = 6,end = 7)),
year=as.numeric(str_sub(string = ObservationDate,start = 0,end = 4)))%>%
select(day,month,year,TMax,TMin,HRMax,HRMin,WindSpeed,Rg,Rainfall)
filename='meteo_SMSE'
dir_raw = '../parameters/'
generate_meteo(dir_raw = dir_raw,filename = filename ,date_ini = '2012-01-01',date_end = '2013-01-01')
filename='meteo_SMSE'
dir_raw = '../parameters/'
date_ini = '2012-01-01'
date_end = '2013-01-01'
meteofile= read.table(file = paste0(dir_raw,filename,'.txt'),header = F)
colnames(meteofile)=c('day','month','year','TMax','TMin','HRMax','HRMin','WindSpeed','Rg','Rainfall')
meteofile=meteofile%>%
mutate(date=dmy(paste(day,month,year)))
min=min(meteofile$date)
max=max(meteofile$date)
if (!is.null(date_ini)){
date_ini=dmy(date_ini)
if(date_ini<min){
print(paste('error: select date_ini after',min))
return(NULL)
}
}else{date_ini=min}
min
max
!is.null(date_ini)
date_ini = '2012-01-01'
!is.null(date_ini)
date_ini=dmy(date_ini)
if(date_ini<min){
print(paste('error: select date_ini after',min))
return(NULL)
}
min
generate_meteo(dir_raw = dir_raw,filename = filename ,date_ini = '2013-01-01',date_end = '2014-01-01')
filename='meteo_SMSE'
dir_raw = '../parameters/'
generate_meteo(dir_raw = dir_raw,filename = filename ,date_ini = '2013-01-01',date_end = '2014-01-01')
date_ini = '2013-01-01'
date_end = '2014-01-01'
meteofile= read.table(file = paste0(dir_raw,filename,'.txt'),header = F)
colnames(meteofile)=c('day','month','year','TMax','TMin','HRMax','HRMin','WindSpeed','Rg','Rainfall')
meteofile=meteofile%>%
mutate(date=dmy(paste(day,month,year)))
min=min(meteofile$date)
max=max(meteofile$date)
date_ini
meteofile=meteofile%>%
filter(date>=date_ini & date<=date_end)%>%
select(-date)
meteofile
min=min(meteofile$date)
max=max(meteofile$date)
if (!is.null(date_ini)){
date_ini=dmy(date_ini)
if(date_ini<min){
print(paste('error: select date_ini after',min))
return(NULL)
}
}else{date_ini=min}
!is.null(date_ini)
generate_meteo(dir_raw = dir_raw,filename = filename ,date_ini = '01-01-2013',date_end = '01-01-2014')
don_phyto%>%
group_by(date)%>%
summarise(totalLeafArea=sum(LEAFAREA,na.rm=T))%>%
ggplot(aes(x=date,y=totalLeafArea))+
geom_line()
don_phyto%>%
group_by(date,sex)%>%
filter(LEAFAREA>0)%>%
summarise(NumberofLeaves=n())%>%
ungroup()%>%
tidyr::spread(sex,NumberofLeaves)%>%
mutate(NumberofLeaves=female+male)%>%
ggplot()+
geom_line(aes(x=date,y=male,col='male'))+
geom_line(aes(x=date,y=female,col='female'))+
geom_line(aes(x=date,y=NumberofLeaves))
names(don_phyto)
View(don_phyto)
don_phyto%>%
group_by(NUMBER)%>%
summarise(SF_FIN=unique(SF_FIN))%>%
ggplot(aes(x=NUMBER,y=SF_FIN))+
geom_line()
don_phyto%>%
group_by(NUMBER)%>%
summarise(SF_FIN=unique(SF_FIN))%>%
ggplot(aes(x=NUMBER,y=SF_FIN))+
geom_point()
don_phyto%>%
group_by(NUMBER)%>%
summarise(SF_FIN=unique(LEAFAREA))%>%
ggplot(aes(x=NUMBER,y=SF_FIN))+
geom_point()
don_phyto%>%
group_by(date)%>%
summarise(totalLeafArea=sum(LEAFAREA,na.rm=T))%>%
ggplot(aes(x=date,y=totalLeafArea))+
geom_line()
don_phyto%>%
group_by(date,sex)%>%
filter(LEAFAREA>0)%>%
summarise(NumberofLeaves=n())%>%
ungroup()%>%
tidyr::spread(sex,NumberofLeaves)%>%
mutate(NumberofLeaves=female+male)%>%
ggplot()+
geom_line(aes(x=date,y=male,col='male'))+
geom_line(aes(x=date,y=female,col='female'))+
geom_line(aes(x=date,y=NumberofLeaves))
View(don_phyto)
don_phyto%>%
group_by(date,sex)%>%
filter(LEAFAREA>0)%>%
summarise(NumberofLeaves=n(),
lastLeaf=max(NUMBER))%>%
ungroup()%>%
tidyr::spread(sex,NumberofLeaves)%>%
mutate(NumberofLeaves=female+male)%>%
ggplot()+
geom_line(aes(x=date,y=male,col='male'))+
geom_line(aes(x=date,y=female,col='female'))+
geom_line(aes(x=date,y=NumberofLeaves,col=lastLeaf))
don_phyto%>%
group_by(date)%>%
filter(LEAFAREA>0)%>%
summarise(NumberofLeaves=n(),
lastLeaf=max(NUMBER))%>%
ungroup()%>%
ggplot(aes(x=date,y=totalLeafArea,col=lastLeaf))+
geom_line()
don_phyto%>%
group_by(date)%>%
filter(LEAFAREA>0)%>%
summarise(totalLeafArea=sum(LEAFAREA),
lastLeaf=max(NUMBER))%>%
ungroup()%>%
ggplot(aes(x=date,y=totalLeafArea,col=lastLeaf))+
geom_line()
don_phyto%>%
group_by(date)%>%
filter(LEAFAREA>0)%>%
summarise(totalLeafArea=sum(LEAFAREA),
lastLeaf=max(NUMBER))%>%
ungroup()%>%
ggplot(aes(x=date,y=totalLeafArea,col=as.factor(lastLeaf)))+
geom_line()
ggplotly(don_phyto%>%
group_by(date)%>%
filter(LEAFAREA>0)%>%
summarise(totalLeafArea=sum(LEAFAREA),
lastLeaf=max(NUMBER))%>%
ungroup()%>%
ggplot(aes(x=date,y=totalLeafArea,col=lastLeaf))+
geom_point())
ggplotly(don_phyto%>%
group_by(date)%>%
filter(LEAFAREA>0)%>%
summarise(numberofLeaves=n(),
totalLeafArea=sum(LEAFAREA),
lastLeaf=max(NUMBER))%>%
ungroup()%>%
ggplot(aes(x=date,y=numberofLeaves,col=lastLeaf))+
geom_point())
don_phyto%>%
group_by(NUMBER)%>%
summarise(SF_FIN=unique(LEAFAREA))%>%
ggplot(aes(x=NUMBER,y=SF_FIN))+
geom_point()
View(don_phyto)
don_phyto%>%
group_by(NUMBER)%>%
summarise(SF_FIN=unique(LEAFAREA))%>%
ggplot(aes(x=NUMBER,y=SF_FIN))+
geom_point()
don_phyto%>%
group_by(NUMBER)%>%
filter(LEAFAREA>0)%>%
summarise(SF_FIN=unique(LEAFAREA))%>%
ggplot(aes(x=NUMBER,y=SF_FIN))+
geom_point()
# test= data.table::fread(file =paste0('../Simu/Phyto_Indonesia_seed1.csv'),header=F)
test= data.table::fread(file =paste0('../../bin/msvc14/x64/test2.csv'),header=F)
colnames(test)=c('date','construct','class','varval','V5')
VARS=c('RANK','NUMBER','LEAFAREA','TT_SINCE_APPEARANCE','TT_SINCE_LEAF_EXPAND','TT_INI_HARVEST','TT_INI_FLOWERING','LEAF_STATE','INFLO_STATUS','SF_FIN')
don_raw=test%>%
select(-V5)%>%
filter(construct %in% c('after_compute'))%>%
mutate(item=str_extract(class, "(?<=\\[).+?(?=\\])"))%>%
separate(varval,c('var','value'),sep='=')%>%
mutate(value=as.numeric(value))
don=don_raw%>%
filter(var %in% VARS)%>%
mutate(date=ymd(date))%>%
tidyr::spread(var,value)
id_phyto=don%>%
filter(!is.na(NUMBER))%>%
select(date,item,NUMBER,RANK,TT_SINCE_APPEARANCE,TT_INI_FLOWERING,TT_INI_HARVEST,SF_FIN)
don_leaf=don%>%
filter(!is.na(LEAFAREA))%>%
select(date,item,LEAFAREA,LEAF_STATE,TT_SINCE_LEAF_EXPAND)
don_leaf=merge(don_leaf,id_phyto,all.x=T)
don_inflo=don%>%
select(date,item,INFLO_STATUS)%>%
na.omit()
don_phyto=merge(don_leaf,don_inflo,all.x=T,all.y=F)
summary(don_phyto)
INFLO_STATUS=c(1,9,10,12,17,18,20,42,50,82,146,266)
sex=c('undeterminated','male','male','male','female','female','female','male','female','female','female','male')
state=c('initiated','initiated','non aborted','aborted','initiated','non aborted','aborted','spathe','spathe','oleosynthesis','harvested','senescent')
table_state=data.frame(INFLO_STATUS,sex,state)
levels(table_state$state)=list("initiated"="initiated","aborted"='aborted','non aborted'='non aborted','spathe'='spathe','oleosynthesis'='oleosynthesis','harvested'='harvested','senescent'='senescent')
table_state=table_state%>%
mutate(state=as.character(state),
INFLO_STATUS=as.numeric(INFLO_STATUS))
don_phyto=don_phyto%>%
mutate(INFLO_STATUS=as.numeric(INFLO_STATUS))%>%
as.data.frame()
don_phyto=merge(don_phyto,table_state,all.x=T)
don_phyto%>%
group_by(NUMBER)%>%
filter(LEAFAREA>0)%>%
summarise(SF_FIN=unique(LEAFAREA))%>%
ggplot(aes(x=NUMBER,y=SF_FIN))+
geom_point()
ggplotly(don_phyto%>%
group_by(date)%>%
filter(LEAFAREA>0)%>%
summarise(numberofLeaves=n(),
totalLeafArea=sum(LEAFAREA),
lastLeaf=max(NUMBER))%>%
ungroup()%>%
ggplot(aes(x=date,y=numberofLeaves,col=lastLeaf))+
geom_point())
don_phyto%>%
group_by(date,sex)%>%
filter(LEAFAREA>0)%>%
summarise(NumberofLeaves=n(),
lastLeaf=max(NUMBER))%>%
ungroup()%>%
tidyr::spread(sex,NumberofLeaves)%>%
mutate(NumberofLeaves=female+male)%>%
ggplot()+
geom_line(aes(x=date,y=male,col='male'))+
geom_line(aes(x=date,y=female,col='female'))+
geom_line(aes(x=date,y=NumberofLeaves))
don_phyto%>%
group_by(date,sex)%>%
filter(LEAFAREA>0)%>%
summarise(NumberofLeaves=n(),
lastLeaf=max(NUMBER))%>%
ungroup()%>%
tidyr::spread(sex,NumberofLeaves)%>%
mutate(NumberofLeaves=female+male)%>%
ggplot()+
geom_line(aes(x=date,y=male,col='male'))+
geom_line(aes(x=date,y=female,col='female'))+
geom_line(aes(x=date,y=NumberofLeaves))
don_phyto%>%
group_by(date,sex)%>%
# filter(LEAFAREA>0)%>%
summarise(NumberofLeaves=n(),
lastLeaf=max(NUMBER))%>%
ungroup()%>%
tidyr::spread(sex,NumberofLeaves)%>%
mutate(NumberofLeaves=female+male)%>%
ggplot()+
geom_line(aes(x=date,y=male,col='male'))+
geom_line(aes(x=date,y=female,col='female'))+
geom_line(aes(x=date,y=NumberofLeaves))
don_phyto%>%
group_by(date,sex)%>%
filter(LEAFAREA>0)%>%
summarise(NumberofLeaves=n(),
lastLeaf=max(NUMBER))%>%
ungroup()
don_phyto%>%
group_by(date,sex)%>%
filter(LEAFAREA>0)%>%
summarise(NumberofLeaves=n(),
lastLeaf=max(NUMBER))%>%
ungroup()%>%
tidyr::spread(sex,NumberofLeaves)%>%
mutate(NumberofLeaves=female+male)
don_phyto%>%
group_by(date,sex)%>%
filter(LEAFAREA>0)%>%
summarise(NumberofLeaves=n())%>%
ungroup()%>%
tidyr::spread(sex,NumberofLeaves)%>%
mutate(NumberofLeaves=female+male)%>%
ggplot()+
geom_line(aes(x=date,y=male,col='male'))+
geom_line(aes(x=date,y=female,col='female'))+
geom_line(aes(x=date,y=NumberofLeaves))
# test= data.table::fread(file =paste0('../Simu/Phyto_Indonesia_seed1.csv'),header=F)
test= data.table::fread(file =paste0('../../bin/msvc14/x64/test.csv'),header=F)
colnames(test)=c('date','construct','class','varval','V5')
VARS=c('RANK','NUMBER','LEAFAREA','TT_SINCE_APPEARANCE','TT_SINCE_LEAF_EXPAND','TT_INI_HARVEST','TT_INI_FLOWERING','LEAF_STATE','INFLO_STATUS','SF_FIN')
don_raw=test%>%
select(-V5)%>%
filter(construct %in% c('after_compute'))%>%
mutate(item=str_extract(class, "(?<=\\[).+?(?=\\])"))%>%
separate(varval,c('var','value'),sep='=')%>%
mutate(value=as.numeric(value))
unique(don_raw$var)
don=don_raw%>%
filter(var %in% VARS)%>%
mutate(date=ymd(date))%>%
tidyr::spread(var,value)
id_phyto=don%>%
filter(!is.na(NUMBER))%>%
select(date,item,NUMBER,RANK,TT_SINCE_APPEARANCE,TT_INI_FLOWERING,TT_INI_HARVEST,SF_FIN)
don_leaf=don%>%
filter(!is.na(LEAFAREA))%>%
select(date,item,LEAFAREA,LEAF_STATE,TT_SINCE_LEAF_EXPAND)
don_leaf=merge(don_leaf,id_phyto,all.x=T)
don_inflo=don%>%
select(date,item,INFLO_STATUS)%>%
na.omit()
don_phyto=merge(don_leaf,don_inflo,all.x=T,all.y=F)
summary(don_phyto)
INFLO_STATUS=c(1,9,10,12,17,18,20,42,50,82,146,266)
sex=c('undeterminated','male','male','male','female','female','female','male','female','female','female','male')
state=c('initiated','initiated','non aborted','aborted','initiated','non aborted','aborted','spathe','spathe','oleosynthesis','harvested','senescent')
table_state=data.frame(INFLO_STATUS,sex,state)
levels(table_state$state)=list("initiated"="initiated","aborted"='aborted','non aborted'='non aborted','spathe'='spathe','oleosynthesis'='oleosynthesis','harvested'='harvested','senescent'='senescent')
table_state=table_state%>%
mutate(state=as.character(state),
INFLO_STATUS=as.numeric(INFLO_STATUS))
don_phyto=don_phyto%>%
mutate(INFLO_STATUS=as.numeric(INFLO_STATUS))%>%
as.data.frame()
don_phyto=merge(don_phyto,table_state,all.x=T)
don_phyto%>%
group_by(NUMBER)%>%
filter(LEAFAREA>0)%>%
summarise(SF_FIN=unique(LEAFAREA))%>%
ggplot(aes(x=NUMBER,y=SF_FIN))+
geom_point()
ggplotly(don_phyto%>%
group_by(date)%>%
filter(LEAFAREA>0)%>%
summarise(numberofLeaves=n(),
totalLeafArea=sum(LEAFAREA),
lastLeaf=max(NUMBER))%>%
ungroup()%>%
ggplot(aes(x=date,y=numberofLeaves,col=lastLeaf))+
geom_point())
don_phyto%>%
group_by(date,sex)%>%
filter(LEAFAREA>0)%>%
summarise(NumberofLeaves=n())%>%
ungroup()%>%
tidyr::spread(sex,NumberofLeaves)%>%
mutate(NumberofLeaves=female+male)%>%
ggplot()+
geom_line(aes(x=date,y=male,col='male'))+
geom_line(aes(x=date,y=female,col='female'))+
geom_line(aes(x=date,y=NumberofLeaves))
filename='meteo_SMSE'
dir_raw = '../parameters/'
generate_meteo(dir_raw = dir_raw,filename = filename)
runApp('App_raph.R')
runApp('App_raph.R')
