# filter(NUMBER %in% c(-76,-50,-11,5,10,15,24))%>%
filter(NUMBER %in% seq(-110,40,3))%>%
mutate(num=paste('phyto #',sprintf( '%03d',NUMBER)))%>%
arrange(date,NUMBER)%>%
group_by(NUMBER)%>%
# filter(RANK>-15 & RANK<65)%>%
ggplot(aes(x=RANK,y=NUMBER,col=state,shape=sex))+
# geom_hline(aes(yintercept =SF_FIN),col=2)+
geom_vline(aes(xintercept =0),lty=2)+
geom_vline(aes(xintercept =50),lty=2)+
# geom_vline(aes(xintercept =TT_INI_FLOWERING,lty='flow'))+
# facet_wrap(~NUMBER)+
geom_point(size=2)+
geom_line(aes(group=num))+
scale_color_viridis_d()+
ylab('# phytomer')+
xlab('Leaf rank')+
myTheme+
theme(legend.position='right')
don_phyto%>%
# filter(NUMBER %in% c(-76,-50,-11,5,10,15,24))%>%
filter(NUMBER %in% seq(-110,40,10))%>%
mutate(num=paste('phyto #',sprintf( '%03d',NUMBER)))%>%
arrange(date,NUMBER)%>%
group_by(NUMBER)%>%
# filter(RANK>-15 & RANK<65)%>%
ggplot(aes(x=RANK,y=NUMBER,col=state,shape=sex))+
# geom_hline(aes(yintercept =SF_FIN),col=2)+
geom_vline(aes(xintercept =0),lty=2)+
geom_vline(aes(xintercept =50),lty=2)+
# geom_vline(aes(xintercept =TT_INI_FLOWERING,lty='flow'))+
# facet_wrap(~NUMBER)+
geom_point(size=2)+
geom_line(aes(group=num))+
scale_color_viridis_d()+
ylab('# phytomer')+
xlab('Leaf rank')+
myTheme+
theme(legend.position='right')
don_phyto%>%
# filter(NUMBER %in% c(-76,-50,-11,5,10,15,24))%>%
filter(NUMBER %in% seq(-110,40,7))%>%
mutate(num=paste('phyto #',sprintf( '%03d',NUMBER)))%>%
arrange(date,NUMBER)%>%
group_by(NUMBER)%>%
# filter(RANK>-15 & RANK<65)%>%
ggplot(aes(x=RANK,y=NUMBER,col=state,shape=sex))+
# geom_hline(aes(yintercept =SF_FIN),col=2)+
geom_vline(aes(xintercept =0),lty=2)+
geom_vline(aes(xintercept =50),lty=2)+
# geom_vline(aes(xintercept =TT_INI_FLOWERING,lty='flow'))+
# facet_wrap(~NUMBER)+
geom_point(size=2)+
geom_line(aes(group=num))+
scale_color_viridis_d()+
ylab('# phytomer')+
xlab('Leaf rank')+
myTheme+
theme(legend.position='right')
don_phyto%>%
# filter(NUMBER %in% c(-76,-50,-11,5,10,15,24))%>%
filter(NUMBER %in% seq(-110,40,15))%>%
mutate(num=paste('phyto #',sprintf( '%03d',NUMBER)))%>%
arrange(date,NUMBER)%>%
group_by(NUMBER)%>%
# filter(RANK>-15 & RANK<65)%>%
ggplot(aes(x=RANK,y=NUMBER,col=state,shape=sex))+
# geom_hline(aes(yintercept =SF_FIN),col=2)+
geom_vline(aes(xintercept =0),lty=2)+
geom_vline(aes(xintercept =50),lty=2)+
# geom_vline(aes(xintercept =TT_INI_FLOWERING,lty='flow'))+
# facet_wrap(~NUMBER)+
geom_point(size=2)+
geom_line(aes(group=num))+
scale_color_viridis_d()+
ylab('# phytomer')+
xlab('Leaf rank')+
myTheme+
theme(legend.position='right')
don_phyto%>%
# filter(NUMBER %in% c(-76,-50,-11,5,10,15,24))%>%
filter(NUMBER %in% seq(-110,40,15))%>%
mutate(num=paste('phyto #',sprintf( '%03d',NUMBER)))%>%
arrange(date,NUMBER)%>%
group_by(NUMBER)%>%
# filter(RANK>-15 & RANK<65)%>%
ggplot(aes(x=RANK,y=NUMBER,col=state,shape=sex))+
# geom_hline(aes(yintercept =SF_FIN),col=2)+
geom_vline(aes(xintercept =0),lty=2)+
geom_vline(aes(xintercept =50),lty=2)+
# geom_vline(aes(xintercept =TT_INI_FLOWERING,lty='flow'))+
# facet_wrap(~NUMBER)+
geom_point(size=4)+
geom_line(aes(group=num))+
scale_color_viridis_d()+
ylab('# phytomer')+
xlab('Leaf rank')+
myTheme+
theme(legend.position='right')
don_phyto%>%
# filter(NUMBER %in% c(-76,-50,-11,5,10,15,24))%>%
filter(NUMBER %in% seq(-110,40,5))%>%
mutate(num=paste('phyto #',sprintf( '%03d',NUMBER)))%>%
arrange(date,NUMBER)%>%
group_by(NUMBER)%>%
# filter(RANK>-15 & RANK<65)%>%
ggplot(aes(x=RANK,y=NUMBER,col=state,shape=sex))+
# geom_hline(aes(yintercept =SF_FIN),col=2)+
geom_vline(aes(xintercept =0),lty=2)+
geom_vline(aes(xintercept =50),lty=2)+
# geom_vline(aes(xintercept =TT_INI_FLOWERING,lty='flow'))+
# facet_wrap(~NUMBER)+
geom_point(size=1)+
geom_line(aes(group=num))+
scale_color_viridis_d()+
ylab('# phytomer')+
xlab('Leaf rank')+
myTheme+
theme(legend.position='right')
don_phyto%>%
# filter(NUMBER %in% c(-76,-50,-11,5,10,15,24))%>%
filter(NUMBER %in% seq(-110,40,5))%>%
mutate(num=paste('phyto #',sprintf( '%03d',NUMBER)))%>%
arrange(date,NUMBER)%>%
group_by(NUMBER)%>%
# filter(RANK>-15 & RANK<65)%>%
ggplot(aes(x=RANK,y=NUMBER,col=state,shape=sex))+
# geom_hline(aes(yintercept =SF_FIN),col=2)+
geom_vline(aes(xintercept =0),lty=2)+
geom_vline(aes(xintercept =50),lty=2)+
# geom_vline(aes(xintercept =TT_INI_FLOWERING,lty='flow'))+
# facet_wrap(~NUMBER)+
geom_point(size=4)+
geom_line(aes(group=num))+
scale_color_viridis_d()+
ylab('# phytomer')+
xlab('Leaf rank')+
myTheme+
theme(legend.position='right')
###script to test and visualize outputs of Xpalm at tree scale###
##R PEREZ, March 2020
# Load packages -----------------------------------------------------------
packs <- c("lubridate", "stringr", "ggplot2",'dplyr','viridis','tidyr','data.table','plotly','cowplot')
InstIfNec<-function (pack) {
if (!do.call(require,as.list(pack))) {
do.call(install.packages,as.list(pack))  }
do.call(require,as.list(pack)) }
lapply(packs, InstIfNec)
files=list.files(path = '../Simu/',pattern = 'Observer')
# theme -------------------------------------------------------------------
myTheme <- theme(
panel.background=element_rect(fill="transparent", color=NA),
plot.background = element_rect(fill = "transparent",colour = NA),
axis.line=element_line(colour="black"),
axis.title=element_text(size=16),
axis.text.y=element_text(size=14, colour="black"),
axis.text.x=element_text(size=14, colour="black", angle=0, hjust=0.5),
panel.grid.minor = element_blank(),
panel.grid.major = element_line(colour="grey90", size=0.2),
legend.position="bottom",
legend.text=element_text(size=14),
legend.title=element_text(size=14)
)
# import data -------------------------------------------------------------
don_tree=NULL
for (file in files){
id=paste0('ind_',str_extract(string = file,pattern = "(?<=seed).+?(?=.csv)"))
site=str_extract(string = file,pattern = "(?<=Observer_).+?(?=_seed)")
raw=data.table::fread(file =paste0('../Simu/',file),header=T)
sim_tree=raw%>%
mutate(id=id,site=site,
Date=ymd(Date),
FFB=BUNCH_OIL_BIOMASS_HARVESTED+BUNCH_NONOIL_BIOMASS_HARVESTED)
don_tree=rbind(don_tree,sim_tree)
}
###visu outputs after x days
# delay=600
# don_tree=don_tree%>%
#   filter(Date>min(Date)+delay)
# water balance data --------------------------------------------------------------
gr_ftsw=don_tree%>%
ggplot(aes(x=Date,y=FTSW,col=site))+
geom_line()+
myTheme
# IC--------------------------------------------------------------
gr_ic=don_tree%>%
filter(id=='ind_1')%>%
ggplot(aes(x=Date,y=IC,col=site,group=paste(id,site)))+
geom_hline(yintercept = 1)+
geom_line()+
ylab('Competiton Index')+
myTheme
# graph LAI ---------------------------------------------------------------
don_tree%>%
ggplot(aes(x=Date,y=LAI,col=site,group=paste(id,site)))+
geom_line()+
myTheme
# graph ASSIM---------------------------------------------------------------
don_tree%>%
ggplot(aes(x=Date,y=ASSIM,col=site))+
facet_wrap(~id)+
geom_line()
# graph FFB ----------------------------------------------------------------
prod_cum=don_tree%>%
mutate(bunch=ifelse(FFB>0,1,0),
male=ifelse(MALE_BIOMASS_HARVESTED>0,1,0))%>%
mutate(month=ymd(paste0(str_sub(string =Date,start = 0,end = 7),'-01')))%>%
group_by(site,id,month)%>%
summarize(total_bunches=sum(bunch),
total_male=sum(male),
total_FFB=sum(FFB/1000))%>%
ungroup()%>%
arrange(site,id,month)%>%
group_by(site,id)%>%
mutate(cum_bunches=cumsum(total_bunches),
cum_male=cumsum(total_male),
cum_FFB=cumsum(total_FFB))%>%
ungroup()
summary(prod_cum)
gr_bunch=prod_cum%>%
ggplot(aes(x=month,y=cum_bunches,col=site,group=paste(id,site),lty=id,pch=id))+
# facet_wrap(~id)+
geom_line()+
geom_point()+
ylab("# harveted bunches")+
xlab('')+
myTheme
don_tree%>%
ggplot(aes(x=Date,y=LAI,col=site,group=paste(id,site)))+
geom_line()+
myTheme
prod_cum=don_tree%>%
mutate(bunch=ifelse(FFB>0,1,0),
male=ifelse(MALE_BIOMASS_HARVESTED>0,1,0))%>%
mutate(month=ymd(paste0(str_sub(string =Date,start = 0,end = 7),'-01')))%>%
group_by(site,id,month)%>%
summarize(total_bunches=sum(bunch),
total_male=sum(male),
total_FFB=sum(FFB/1000))%>%
ungroup()%>%
arrange(site,id,month)%>%
group_by(site,id)%>%
mutate(cum_bunches=cumsum(total_bunches),
cum_male=cumsum(total_male),
cum_FFB=cumsum(total_FFB))%>%
ungroup()
summary(prod_cum)
gr_bunch=prod_cum%>%
ggplot(aes(x=month,y=cum_bunches,col=site,group=paste(id,site),lty=id,pch=id))+
# facet_wrap(~id)+
geom_line()+
geom_point()+
ylab("# harveted bunches")+
xlab('')+
myTheme
gr_bunch
don_tree%>%
ggplot(aes(x=Date,y=ASSIM,col=site))+
facet_wrap(~id)+
geom_line()
prod_cum=don_tree%>%
mutate(bunch=ifelse(FFB>0,1,0),
male=ifelse(MALE_BIOMASS_HARVESTED>0,1,0))%>%
mutate(month=ymd(paste0(str_sub(string =Date,start = 0,end = 7),'-01')))%>%
group_by(site,id,month)%>%
summarize(total_bunches=sum(bunch),
total_male=sum(male),
total_FFB=sum(FFB/1000))%>%
ungroup()%>%
arrange(site,id,month)%>%
group_by(site,id)%>%
mutate(cum_bunches=cumsum(total_bunches),
cum_male=cumsum(total_male),
cum_FFB=cumsum(total_FFB))%>%
ungroup()
gr_FFB=prod_cum%>%
ggplot(aes(x=month,y=cum_FFB,col=site,group=paste(id,site),lty=id,pch=id))+
# facet_wrap(~id)+
geom_line()+
geom_point()+
ylab("FFB (kg.plant-1)")+
xlab('')+
myTheme
gr_FFB
don_tree%>%
ggplot(aes(x=Date,y=FFB,col=site))+
facet_wrap(~id)+
geom_line()
don_tree%>%
ggplot(aes(x=Date,y=FFB,col=site))+
facet_wrap(~id)+
geom_col()
don_tree%>%
ggplot(aes(x=Date,y=FFB/1000,col=site))+
facet_wrap(~id)+
geom_col()
don_tree%>%
ggplot(aes(x=Date,y=FFB/1000,col=site))+
facet_wrap(Site~id)+
geom_col()
don_tree%>%
ggplot(aes(x=Date,y=FFB/1000,col=site))+
facet_wrap(site~id)+
geom_col()
don_tree%>%
ggplot(aes(x=Date,y=FFB/1000,fill=site))+
facet_wrap(site~id)+
geom_col()
don_tree%>%
ggplot(aes(x=Date,y=FFB/1000))+
facet_wrap(site~id)+
geom_col()
don_tree%>%
ggplot(aes(x=Date,y=ASSIM,col=site))+
facet_wrap(~id)+
geom_line()
don_tree%>%
ggplot(aes(x=Date,y=FFB/1000,group=paste(id,site)))+
facet_wrap(site~id)+
geom_col()
don_tree%>%
ggplot(aes(x=Date,y=FFB/1000,group=paste(id,site)))+
facet_wrap(site~id)+
geom_point()
don_tree%>%
mutate(sex=ifelse(FFB>0,'female','male'))%>%
ggplot(aes(x=Date,y=FFB/1000,col=sex))+
facet_wrap(site~id)+
geom_point()
don_tree%>%
mutate(sex=ifelse(FFB>0,'female','male'))%>%
ggplot(aes(x=Date,y=FFB/1000,col=sex))+
facet_wrap(site~id)+
geom_point()+
geom_line()
don_tree%>%
mutate(sex=ifelse(FFB>0,'female','male'))%>%
filter(sex=='female')%>%
ggplot(aes(x=Date,y=FFB/1000))+
facet_wrap(site~id)+
geom_point()+
geom_line()
don_tree%>%
mutate(sex=ifelse(FFB>0,'female','male'))%>%
filter(sex=='female')%>%
ggplot(aes(x=Date,y=FFB/1000,col=site))+
facet_wrap(site~id)+
geom_point()+
geom_line()
don_tree%>%
mutate(sex=ifelse(FFB>0,'female','male'))%>%
filter(sex=='female')%>%
ggplot(aes(x=Date,y=FFB/1000,col=site))+
facet_wrap(~id)+
geom_point()+
geom_line()
don_tree%>%
mutate(sex=ifelse(FFB>0,'female','male'))%>%
filter(sex=='female' & id!='ind3')%>%
ggplot(aes(x=Date,y=FFB/1000,col=site))+
facet_wrap(~id)+
geom_point()+
geom_line()
don_tree%>%
mutate(sex=ifelse(FFB>0,'female','male'))%>%
filter(sex=='female' & id!='ind_3')%>%
ggplot(aes(x=Date,y=FFB/1000,col=site))+
facet_wrap(~id)+
geom_point()+
geom_line()
don_tree%>%
mutate(sex=ifelse(FFB>0,'female','male'))%>%
filter(sex=='female' & id!='ind_3')%>%
ggplot(aes(x=Date,y=FFB/1000,col=site))+
facet_wrap(~id)+
geom_point()+
geom_line()+
ylab("FFB (kg.plant-1)")+
prod_cum=don_tree%>%
mutate(bunch=ifelse(FFB>0,1,0),
male=ifelse(MALE_BIOMASS_HARVESTED>0,1,0))%>%
mutate(month=ymd(paste0(str_sub(string =Date,start = 0,end = 7),'-01')))%>%
group_by(site,id,month)%>%
summarize(total_bunches=sum(bunch),
total_male=sum(male),
total_FFB=sum(FFB/1000))%>%
ungroup()%>%
arrange(site,id,month)%>%
group_by(site,id)%>%
mutate(cum_bunches=cumsum(total_bunches),
cum_male=cumsum(total_male),
cum_FFB=cumsum(total_FFB))%>%
ungroup()
don_tree%>%
mutate(sex=ifelse(FFB>0,'female','male'))%>%
filter(sex=='female' & id!='ind_3')%>%
ggplot(aes(x=Date,y=FFB/1000,col=site))+
facet_wrap(~id)+
geom_point()+
geom_line()+
ylab("FFB (kg.plant-1)")
don_tree%>%
mutate(sex=ifelse(FFB>0,'female','male'))%>%
filter(sex=='female' & id!='ind_3')%>%
ggplot(aes(x=Date,y=FFB/1000,col=site))+
facet_wrap(~id)+
geom_point()+
geom_line()+
ylab("FFB (kg.plant-1)")+
myTheme
don_tree%>%
mutate(sex=ifelse(FFB>0,'female','male'))%>%
filter(sex=='female' & id!='ind_3')%>%
ggplot(aes(x=Date,y=FFB/1000,col=site))+
facet_wrap(~id)+
geom_point()+
geom_line()+
ylab("FFB (kg.bunch-1)")+
myTheme
packs <- c("lubridate", "stringr", "ggplot2",'dplyr','viridis','tidyr','data.table','plotly')
InstIfNec<-function (pack) {
if (!do.call(require,as.list(pack))) {
do.call(install.packages,as.list(pack))  }
do.call(require,as.list(pack)) }
lapply(packs, InstIfNec)
myTheme <- theme(
panel.background=element_rect(fill="transparent", color=NA),
plot.background = element_rect(fill = "transparent",colour = NA),
axis.line=element_line(colour="black"),
axis.title=element_text(size=16),
axis.text.y=element_text(size=14, colour="black"),
axis.text.x=element_text(size=14, colour="black", angle=0, hjust=0.5),
panel.grid.minor = element_blank(),
panel.grid.major = element_line(colour="grey90", size=0.2),
legend.position="bottom",
legend.text=element_text(size=14),
legend.title=element_text(size=14)
)
source('generate_params.R')
source('generate_meteo.R')
age_ini=3
seed=1
generate_param(dir='../parameters/',filename = 'XPalm_parameters',AGE_INI = age_ini,SEED = seed)
meteo_file="meteo_SMSE"
generate_meteo(dir_raw = '../parameters/',filename = meteo_file,date_ini = NULL,date_end = NULL)
sim_name=paste0('Simu_',meteo_file,'_age',age_ini,'_seed',seed)
don=data.table::fread(file =paste0('../../bin/msvc14/x64/results.csv'),header=T)%>%
mutate(Date=ymd(Date),
Age=(Date-first(Date))/365)
save(x=don,file =paste0('../Simu/',sim_name,'.RData'))
load(paste0('../Simu/',sim_name,'.RData'))
vars=don%>%
select(-c(Date,Age))%>%
colnames()
tableVar=data.frame(var=vars,min=0,max=NA,type='sink & source')
levels(tableVar$type)=c('sink & source','meteo','prod')
tableVar[tableVar$var %in% c('EI','FRACTION_NON_STR_BIOMASS_TOTAL','FR_FRUITS','FR_RESTE','FTSW'),]$max=1
tableVar[tableVar$var %in% c('C_BALANCE'),]$max=0
tableVar[tableVar$var %in% c('FRACTION_NON_STR_BIOMASS_TOTAL'),]$min=2
tableVar[tableVar$var %in% c("FTSW","RG","RAIN","TEFF"),]$type='meteo'
tableVar[tableVar$var %in% c("PLANTLEAFAREA",'LAI',"PHYTOMERNUMBER","NEWPHYTOMEREMERGENCE","LEAVES_NON_STRUCTURAL_BIOMASS_HARVESTED","LEAVES_STRUCTURAL_BIOMASS_HARVESTED","MALE_BIOMASS_HARVESTED","PEDUNCLE_BIOMASS_HARVESTED","BUNCH_NONOIL_BIOMASS_HARVESTED","BUNCH_OIL_BIOMASS_HARVESTED","TRUNK_BIOMASS","TRUNK_HEIGHT"),]$type='prod'
don2=don%>%
tidyr::gather(key = 'var',value='value',-c(Date,Age,TREE_AGE))
don2=merge(don2,tableVar)%>%
mutate(outliers=ifelse((!is.na(value) & value<min) |(!is.na(value) & !is.na(max) & value>max),'yes','no'))
out=don2%>%
filter(outliers=='yes')
pdf(paste0('../Outputs/',sim_name,'.pdf'),onefile = T)
DEV;OFF5
dev.off()
dev.off()
sub=don2%>%
filter(type==t)
t=unique(don2$type)[1]
t
gr=ggplot()+
geom_hline(data = sub,aes(yintercept = min),lty=2)+
geom_hline(data = sub,aes(yintercept = max),lty=2)+
geom_path(data=sub,aes(x=Date,y=value))+
geom_point(data=sub[sub$outliers=='yes',],aes(y=value,x=Date,col='outliers'))+
facet_wrap(~var,scales = 'free_y')+
myTheme
print(gr)
sub=don2%>%
filter(type==t)
gr=ggplot()+
geom_hline(data = sub,aes(yintercept = min),lty=2)+
geom_hline(data = sub,aes(yintercept = max),lty=2)+
geom_path(data=sub,aes(x=Date,y=value))+
geom_point(data=sub[sub$outliers=='yes',],aes(y=value,x=Date,col='outliers'))+
facet_wrap(~var,scales = 'free_y')+
myTheme
print(gr)
dev.off()
dev.off()
pdf(paste0('../Outputs/',sim_name,'.pdf'),onefile = T)
print(out)
for (t in unique(don2$type)){
sub=don2%>%
filter(type==t)
gr=ggplot()+
geom_hline(data = sub,aes(yintercept = min),lty=2)+
geom_hline(data = sub,aes(yintercept = max),lty=2)+
geom_path(data=sub,aes(x=Date,y=value))+
geom_point(data=sub[sub$outliers=='yes',],aes(y=value,x=Date,col='outliers'))+
facet_wrap(~var,scales = 'free_y')+
myTheme
print(gr)
}
dev.off()
sim_name
print(out)
